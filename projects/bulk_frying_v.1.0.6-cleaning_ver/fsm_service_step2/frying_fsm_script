#!/bin/bash

# 'python3 run.py' 프로세스가 실행 중인지 확인하는 함수
is_run_py_running() {
    pgrep -f "run.py --project=bulk_frying" > /dev/null
}

# FSM 서비스를 시작하는 메인 함수
start_frying_fsm() {
    echo "[INFO] Starting Frying FSM Service..."

    # register_service.sh에 의해 올바른 프로젝트 루트 경로로 대체됩니다.
    cd "PROJECT_ROOT_PATH_PLACEHOLDER" || {
        echo "[FATAL] 프로젝트 디렉터리 이동 실패. 서비스를 중단합니다."
        exit 1
    }

    echo "[INFO] 현재 작업 디렉터리: $(pwd)"
    
    # 다른 스크립트들을 먼저 실행합니다.
    ./update_ips.sh || true
    ./killTasks.sh || true
    
    while true; do
    # run.py가 실행 중이 아니라면, 모든 출력을 로그 파일에 기록하며 직접 시작합니다.
    	if ! is_run_py_running; then
        	echo "[INFO] run.py가 실행되고 있지 않습니다. 새로 시작합니다..."
        	./run.sh
        fi
	sleep 10
    done
}

### 스크립트 시작 지점 ###
echo "--- Service script /etc/frying_fsm_script started ---"

# 로봇 상태 확인 스크립트는 '절대 경로'로 실행해야 합니다.
while ! /usr/bin/python3 /home/user/release/codex_agents_indycare/fsm_service_step2/check_robot_status.py; do
    echo "[WAIT] 로봇이 준비되지 않았습니다. 5초 후 다시 시도합니다..."
    sleep 5
done

echo "[SUCCESS] 로봇이 준비되었습니다. 메인 애플리케이션을 시작합니다."
start_frying_fsm
